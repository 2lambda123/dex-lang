<!DOCTYPE HTML>
<html><head><link rel="stylesheet" href="style.css" type="text/css"><meta charset="UTF-8"></head><body><div id="main-output"><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Dex prelude</h2>
</div></div><div class="cell"><div class="prose-block"><p>Runs before every Dex program unless an alternative is provided with <code>--prelude</code>.</p>
</div></div><div class="cell"><div class="prose-block"><p>Wrappers around primitives</p>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int</span>  <span class="symbol">=</span> %<span class="type-name">Int</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Real</span> <span class="symbol">=</span> %<span class="type-name">Real</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Unit</span> <span class="symbol">=</span> %<span class="type-name">UnitType</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">TyKind</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Effects</span> <span class="symbol">=</span> %<span class="type-name">EffKind</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;</span>) (a<span class="symbol">:</span><span class="type-name">Type</span>) (b<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">PairType</span> a b
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">,</span>) (x<span class="command">:a</span>) (y<span class="command">:b</span>) <span class="symbol">:</span> a <span class="symbol">&amp;</span> b <span class="symbol">=</span> %pair x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fst (p<span class="symbol">:</span> a <span class="symbol">&amp;</span> b) <span class="symbol">:</span> a <span class="symbol">=</span> %fst p
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> snd (p<span class="symbol">:</span> a <span class="symbol">&amp;</span> b) <span class="symbol">:</span> b <span class="symbol">=</span> %snd p
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> idiv (x<span class="symbol">:</span><span class="type-name">Int</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %idiv x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rem  (x<span class="symbol">:</span><span class="type-name">Int</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %irem x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ipow (x<span class="symbol">:</span><span class="type-name">Int</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %ipow x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> neg  (x<span class="symbol">:</span><span class="type-name">Real</span>)          <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %fneg x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fdiv (x<span class="symbol">:</span><span class="type-name">Real</span>) (y<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %fdiv x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Add</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span>
  <span class="type-name">MkAdd</span> (a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a) (a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a) a  <span class="comment">-- add, sub, zero
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+</span>)  (d<span class="symbol">:</span><span class="type-name">Add</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkAdd</span> add _   _    <span class="symbol">-&gt;</span> add
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">-</span>)  (d<span class="symbol">:</span><span class="type-name">Add</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkAdd</span> _   sub _    <span class="symbol">-&gt;</span> sub
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> zero (d<span class="symbol">:</span><span class="type-name">Add</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a           <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkAdd</span> _   _   zero <span class="symbol">-&gt;</span> zero
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance realAdd <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Real</span> <span class="symbol">=</span> <span class="type-name">MkAdd</span> (<span class="symbol">\</span>x y<span class="symbol">.</span> %fadd x y) (<span class="symbol">\</span>x y<span class="symbol">.</span> %fsub x y) 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance intAdd  <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Int</span>  <span class="symbol">=</span> <span class="type-name">MkAdd</span> (<span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y) (<span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y) 0
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance unitAdd <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Unit</span> <span class="symbol">=</span> <span class="type-name">MkAdd</span> (<span class="symbol">\</span>x y<span class="symbol">.</span> ())        (<span class="symbol">\</span>x y<span class="symbol">.</span> ())        ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance tabAdd <span class="symbol">:</span> <span class="type-name">Add</span> a <span class="symbol">?=&gt;</span> <span class="type-name">Add</span> (n<span class="symbol">=&gt;</span>a) <span class="symbol">=</span>
  (<span class="type-name">MkAdd</span> ( <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i )
         ( <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i )
         ( <span class="keyword">for</span> _<span class="symbol">.</span> zero ))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Mul</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">MkMul</span> (a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a) a  <span class="comment">-- multiply, one
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">*</span>) (d<span class="symbol">:</span><span class="type-name">Mul</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkMul</span> mul _   <span class="symbol">-&gt;</span> mul
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> one (d<span class="symbol">:</span><span class="type-name">Mul</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a           <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkMul</span> _   one <span class="symbol">-&gt;</span> one
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance realMul <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Real</span> <span class="symbol">=</span> <span class="type-name">MkMul</span> (<span class="symbol">\</span>x y<span class="symbol">.</span> %fmul x y) 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance intMul  <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Int</span>  <span class="symbol">=</span> <span class="type-name">MkMul</span> (<span class="symbol">\</span>x y<span class="symbol">.</span> %imul x y) 1
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance unitMul <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Unit</span> <span class="symbol">=</span> <span class="type-name">MkMul</span> (<span class="symbol">\</span>x y<span class="symbol">.</span> ()) ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">VSpace</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">MkVSpace</span> (<span class="type-name">Add</span> a) (<span class="type-name">Real</span> <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>superclass
<span class="keyword">def</span> addFromVSpace (d<span class="symbol">:</span><span class="type-name">VSpace</span> a) <span class="symbol">:</span> <span class="type-name">Add</span> a <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkVSpace</span> addDict _ <span class="symbol">-&gt;</span> addDict
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">flip <span class="symbol">:</span> (a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">-&gt;</span> (b <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> c) <span class="symbol">=</span> <span class="symbol">\</span>f x y<span class="symbol">.</span> f y x
</div></div><div class="cell"><div class="code-block">uncurry <span class="symbol">:</span> (a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">-&gt;</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">-&gt;</span> c <span class="symbol">=</span> <span class="symbol">\</span>f (x<span class="symbol">,</span>y)<span class="symbol">.</span> f x y
</div></div><div class="cell"><div class="code-block">const <span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="symbol">\</span>x _<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">.*</span>)  (d<span class="symbol">:</span><span class="type-name">VSpace</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkVSpace</span> _ scale <span class="symbol">-&gt;</span> scale
</div></div><div class="cell"><div class="code-block">(<span class="symbol">*.</span>)  <span class="symbol">:</span> <span class="type-name">VSpace</span> a <span class="symbol">?=&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Real</span> <span class="symbol">-&gt;</span> a <span class="symbol">=</span> flip (<span class="symbol">.*</span>)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/</span>) (_<span class="symbol">:</span><span class="type-name">VSpace</span> a) <span class="symbol">?=&gt;</span> (v<span class="command">:a</span>) (s<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> a <span class="symbol">=</span> (fdiv 1<span class="symbol">.</span>0 s) <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance realVS <span class="symbol">:</span> <span class="type-name">VSpace</span> <span class="type-name">Real</span> <span class="symbol">=</span> <span class="type-name">MkVSpace</span> realAdd (<span class="symbol">*</span>)
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance tabVS  <span class="symbol">:</span> <span class="type-name">VSpace</span> a <span class="symbol">?=&gt;</span> <span class="type-name">VSpace</span> (n<span class="symbol">=&gt;</span>a) <span class="symbol">=</span> <span class="type-name">MkVSpace</span> tabAdd <span class="symbol">\</span>s xs<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance unitVS <span class="symbol">:</span> <span class="type-name">VSpace</span> <span class="type-name">Unit</span> <span class="symbol">=</span> <span class="type-name">MkVSpace</span> unitAdd <span class="symbol">\</span>s u<span class="symbol">.</span> ()
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="type-name">InternalBool</span> <span class="symbol">=</span> %<span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- XXX: False must come before True for the later coercions to be correct.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="type-name">False</span>
  <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafeCoerce (b<span class="symbol">:</span><span class="type-name">Type</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> b <span class="symbol">=</span> %unsafeCoerce b x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;&amp;</span>) (x<span class="symbol">:</span><span class="type-name">Bool</span>) (y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> unsafeCoerce <span class="type-name">InternalBool</span> x
  y&#39; <span class="symbol">=</span> unsafeCoerce <span class="type-name">InternalBool</span> y
  unsafeCoerce _ <span class="symbol">$</span> %and x&#39; y&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">||</span>) (x<span class="symbol">:</span><span class="type-name">Bool</span>) (y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> unsafeCoerce <span class="type-name">InternalBool</span> x
  y&#39; <span class="symbol">=</span> unsafeCoerce <span class="type-name">InternalBool</span> y
  unsafeCoerce _ <span class="symbol">$</span> %or x&#39; y&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> not  (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> unsafeCoerce <span class="type-name">InternalBool</span> x
  unsafeCoerce _ <span class="symbol">$</span> %not x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Sum types</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">|</span>) (a<span class="symbol">:</span><span class="type-name">Type</span>) (b<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">SumType</span> a b
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> anyVal (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="symbol">:</span> a <span class="symbol">=</span> %anyVal a
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sumCon (isLeft<span class="symbol">:</span><span class="type-name">Bool</span>) (l<span class="command">:a</span>) (r<span class="command">:b</span>) <span class="symbol">:</span> (a<span class="symbol">|</span>b) <span class="symbol">=</span>
  isLeft&#39; <span class="symbol">=</span> unsafeCoerce <span class="type-name">InternalBool</span> isLeft
  %sumCon isLeft&#39; l r
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Left</span>  (x<span class="command">:a</span>) <span class="symbol">:</span> (a<span class="symbol">|</span>b) <span class="symbol">=</span> sumCon <span class="type-name">True</span>  x      anyVal
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Right</span> (x<span class="command">:b</span>) <span class="symbol">:</span> (a<span class="symbol">|</span>b) <span class="symbol">=</span> sumCon <span class="type-name">False</span> anyVal x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> caseAnalysis (x<span class="command">:a</span><span class="symbol">|</span>b) (l<span class="command">:a</span><span class="symbol">-&gt;</span>c) (r<span class="command">:b</span><span class="symbol">-&gt;</span>c) <span class="symbol">:</span> c <span class="symbol">=</span> %caseAnalysis x l r
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> select (p<span class="symbol">:</span><span class="type-name">Bool</span>) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> <span class="keyword">case</span> p <span class="keyword">of</span>
  <span class="type-name">True</span>  <span class="symbol">-&gt;</span> x
  <span class="type-name">False</span> <span class="symbol">-&gt;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b2i (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Int</span>  <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> unsafeCoerce <span class="type-name">InternalBool</span> x
  %booltoint x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> i2r (x<span class="symbol">:</span><span class="type-name">Int</span> ) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %inttoreal x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> b2r (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> i2r (b2i x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> todo (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="symbol">:</span> a <span class="symbol">=</span> %throwError a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Effects</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Ref</span> (r<span class="symbol">:</span><span class="type-name">Type</span>) (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Ref</span> r a
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get  (ref<span class="symbol">:</span><span class="type-name">Ref</span> h s)       <span class="symbol">:</span> {<span class="type-name">State</span> h} s    <span class="symbol">=</span> %get  ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">:=</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h s) (x<span class="command">:s</span>) <span class="symbol">:</span> {<span class="type-name">State</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span> %put  ref x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ask  (ref<span class="symbol">:</span><span class="type-name">Ref</span> h r)       <span class="symbol">:</span> {<span class="type-name">Read</span>  h} r    <span class="symbol">=</span> %ask  ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+=</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h w) (x<span class="command">:w</span>) <span class="symbol">:</span> {<span class="type-name">Accum</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span> %tell ref x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">!</span>)  (ref<span class="symbol">:</span><span class="type-name">Ref</span> h (n<span class="symbol">=&gt;</span>a)) (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Ref</span> h a <span class="symbol">=</span> %indexRef ref i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fstRef (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> <span class="type-name">Ref</span> h a <span class="symbol">=</span> %fstRef ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sndRef (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> <span class="type-name">Ref</span> h b <span class="symbol">=</span> %sndRef ref
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withReader
      (eff<span class="symbol">:</span><span class="type-name">Effects</span>) <span class="symbol">?-&gt;</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (r<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
      (init<span class="command">:r</span>) (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h r <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span>
    <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; r) <span class="symbol">:</span> {<span class="type-name">Read</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
    %runReader init explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withAccum
      (eff<span class="symbol">:</span><span class="type-name">Effects</span>) <span class="symbol">?-&gt;</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (w<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h w <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} (a <span class="symbol">&amp;</span> w) <span class="symbol">=</span>
    <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; w) <span class="symbol">:</span> {<span class="type-name">Accum</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
    %runWriter explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withState
      (eff<span class="symbol">:</span><span class="type-name">Effects</span>) <span class="symbol">?-&gt;</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (s<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
      (init<span class="command">:s</span>)
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h s <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} (a <span class="symbol">&amp;</span> s) <span class="symbol">=</span>
    <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; s) <span class="symbol">:</span> {<span class="type-name">State</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
    %runState init explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Type classes</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Eq</span>  a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">MkEq</span>  (a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>)
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Ord</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">MkOrd</span> (<span class="type-name">Eq</span> a) (a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>) (a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>)  <span class="comment">-- eq, gt, lt
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>superclass
<span class="keyword">def</span> eqFromOrd (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">:</span> <span class="type-name">Eq</span> a <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkOrd</span> eq _ _ <span class="symbol">-&gt;</span> eq
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">==</span>) (d<span class="symbol">:</span><span class="type-name">Eq</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkEq</span> eq <span class="symbol">-&gt;</span> eq x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/=</span>) (d<span class="symbol">:</span><span class="type-name">Eq</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not <span class="symbol">$</span> x <span class="symbol">==</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;</span>)  (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkOrd</span> _ gt _  <span class="symbol">-&gt;</span> gt x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;</span>)  (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkOrd</span> _ _  lt <span class="symbol">-&gt;</span> lt x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;=</span>) (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> x<span class="symbol">&lt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;=</span>) (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> x<span class="symbol">&gt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance intEq  <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Int</span>  <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x y<span class="symbol">.</span> unsafeCoerce _ <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance realEq <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Real</span> <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x y<span class="symbol">.</span> unsafeCoerce _ <span class="symbol">$</span> %feq x y
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance unitEq <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Unit</span> <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance intOrd  <span class="symbol">:</span> <span class="type-name">Ord</span> <span class="type-name">Int</span>  <span class="symbol">=</span> (<span class="type-name">MkOrd</span> intEq  (<span class="symbol">\</span>x y<span class="symbol">.</span> unsafeCoerce _ <span class="symbol">$</span> %igt x y)
                                             (<span class="symbol">\</span>x y<span class="symbol">.</span> unsafeCoerce _ <span class="symbol">$</span> %ilt x y))
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance realOrd <span class="symbol">:</span> <span class="type-name">Ord</span> <span class="type-name">Real</span> <span class="symbol">=</span> (<span class="type-name">MkOrd</span> realEq (<span class="symbol">\</span>x y<span class="symbol">.</span> unsafeCoerce _ <span class="symbol">$</span> %fgt x y)
                                             (<span class="symbol">\</span>x y<span class="symbol">.</span> unsafeCoerce _ <span class="symbol">$</span> %flt x y))
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance unitOrd <span class="symbol">:</span> <span class="type-name">Ord</span> <span class="type-name">Unit</span> <span class="symbol">=</span> <span class="type-name">MkOrd</span> unitEq (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">False</span>) (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">False</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance
<span class="keyword">def</span> pairEq (eqA<span class="symbol">:</span> <span class="type-name">Eq</span> a)<span class="symbol">?=&gt;</span> (eqB<span class="symbol">:</span> <span class="type-name">Eq</span> b)<span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Eq</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">$</span>
  <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">==</span> y2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance
<span class="keyword">def</span> pairOrd (ordA<span class="symbol">:</span> <span class="type-name">Ord</span> a)<span class="symbol">?=&gt;</span> (ordB<span class="symbol">:</span> <span class="type-name">Ord</span> b)<span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Ord</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">=</span>
  pairGt <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">&gt;</span> y1 <span class="symbol">||</span> (x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">&gt;</span> y2)
  pairLt <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">&lt;</span> y1 <span class="symbol">||</span> (x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">&lt;</span> y2)
  <span class="type-name">MkOrd</span> pairEq pairGt pairLt
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance
<span class="keyword">def</span> sumEq (eqA<span class="symbol">:</span> <span class="type-name">Eq</span> a)<span class="symbol">?=&gt;</span> (eqB<span class="symbol">:</span> <span class="type-name">Eq</span> b)<span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Eq</span> (a <span class="symbol">|</span> b) <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">$</span>
  <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="keyword">oldcase</span> x
    <span class="type-name">Left</span>  xVal <span class="symbol">-&gt;</span> <span class="keyword">oldcase</span> y
      <span class="type-name">Left</span>  yVal <span class="symbol">-&gt;</span> xVal <span class="symbol">==</span> yVal
      <span class="type-name">Right</span> yVal <span class="symbol">-&gt;</span> <span class="type-name">False</span>
    <span class="type-name">Right</span> xVal <span class="symbol">-&gt;</span> <span class="keyword">oldcase</span> y
      <span class="type-name">Left</span>  yVal <span class="symbol">-&gt;</span> <span class="type-name">False</span>
      <span class="type-name">Right</span> yVal <span class="symbol">-&gt;</span> xVal <span class="symbol">==</span> yVal
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: accumulate using the True/&amp;&amp; monoid
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance
<span class="keyword">def</span> tabEq (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (eqA<span class="symbol">:</span> <span class="type-name">Eq</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Eq</span> (n<span class="symbol">=&gt;</span>a) <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">$</span>
  <span class="symbol">\</span>xs ys<span class="symbol">.</span>
    numDifferent <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span>
      snd <span class="symbol">$</span> withAccum <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
        ref <span class="symbol">+=</span> (i2r (b2i (xs<span class="symbol">.</span>i <span class="symbol">/=</span> ys<span class="symbol">.</span>i)))
    numDifferent <span class="symbol">==</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Wrappers around C library functions</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> exp (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %exp x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> exp2 (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %exp2 x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> log (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %log x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> log2 (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %log2 x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> log10 (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %log10 x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sin (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %sin x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cos (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %cos x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tan (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %tan x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> floor (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %floor x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ceil (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %ceil x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> round (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %round x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sqrt (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %sqrt x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> pow (x<span class="symbol">:</span><span class="type-name">Real</span>) (y<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %fpow x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Working with index sets</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Range</span> (low<span class="symbol">:</span><span class="type-name">Int</span>) (high<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">IntRange</span> low high
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Fin</span> (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">Range</span> 0 n
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ordinal (i<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %asint i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> size (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %idxSetSize n
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fromOrdinal (n<span class="symbol">:</span><span class="type-name">Type</span>) (i<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span> %asidx n i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> asidx (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (i<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span> fromOrdinal n i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">@</span>) (i<span class="symbol">:</span><span class="type-name">Int</span>) (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> n <span class="symbol">=</span> fromOrdinal n i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixadd (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (i<span class="command">:n</span>) (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span> fromOrdinal n <span class="symbol">$</span> ordinal i <span class="symbol">+</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixsub (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (i<span class="command">:n</span>) (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span> fromOrdinal n <span class="symbol">$</span> ordinal i <span class="symbol">-</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> iota (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Int</span> <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: we want Eq and Ord for all index sets, not just `Fin n`
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance
<span class="keyword">def</span> finEq (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">?-&gt;</span> <span class="symbol">:</span> <span class="type-name">Eq</span> (<span class="type-name">Fin</span> n) <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">==</span> ordinal y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance
<span class="keyword">def</span> finOrd (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">?-&gt;</span> <span class="symbol">:</span> <span class="type-name">Ord</span> (<span class="type-name">Fin</span> n) <span class="symbol">=</span>
  <span class="type-name">MkOrd</span> finEq (<span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">&gt;</span> ordinal y) (<span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">&lt;</span> ordinal y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Misc</p>
</div></div><div class="cell"><div class="code-block">pi <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> 3<span class="symbol">.</span>141592653589793
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> id (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dup (x<span class="command">:a</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> a) <span class="symbol">=</span> (x<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: unpack pair in args once we fix the bug
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> swap (p<span class="command">:a</span><span class="symbol">&amp;</span>b) <span class="symbol">:</span> (b<span class="symbol">&amp;</span>a) <span class="symbol">=</span> (snd p<span class="symbol">,</span> fst p)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> map (f<span class="command">:a</span><span class="symbol">-&gt;</span>{<span class="symbol">|</span>eff} b) (xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} (n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> f xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> zip (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (ys<span class="command">:n</span><span class="symbol">=&gt;</span>b) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> (xs<span class="symbol">.</span>i<span class="symbol">,</span> ys<span class="symbol">.</span>i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unzip (xys<span class="command">:n</span><span class="symbol">=&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>a <span class="symbol">&amp;</span> n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span> (map fst xys<span class="symbol">,</span> map snd xys)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fanout (n<span class="symbol">:</span><span class="type-name">Type</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sq (d<span class="symbol">:</span><span class="type-name">Mul</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> x <span class="symbol">*</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> abs (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> select (x <span class="symbol">&gt;</span> 0<span class="symbol">.</span>0) x (<span class="symbol">-</span>x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mod (x<span class="symbol">:</span><span class="type-name">Int</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> rem (y <span class="symbol">+</span> rem x y) y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> compose (f<span class="command">:b</span><span class="symbol">-&gt;</span>c) (g<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> c <span class="symbol">=</span> f (g x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> slice (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (start<span class="symbol">:</span><span class="type-name">Int</span>) (m<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>(fromOrdinal _ (ordinal i <span class="symbol">+</span> start))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan (init<span class="command">:a</span>) (body<span class="command">:n</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span>
  swap <span class="symbol">$</span> withState init <span class="symbol">\</span>s<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
    c <span class="symbol">=</span> get s
    (c&#39;<span class="symbol">,</span> y) <span class="symbol">=</span> body i c
    s <span class="symbol">:=</span> c&#39;
    y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fold (init<span class="command">:a</span>) (body<span class="symbol">:</span>(n<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a)) <span class="symbol">:</span> a <span class="symbol">=</span> fst <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> (body i x<span class="symbol">,</span> ())
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reduce (identity<span class="command">:a</span>) (binop<span class="symbol">:</span>(a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a)) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  <span class="comment">-- `binop` should be a commutative and associative, and form a
</span>  <span class="comment">-- commutative monoid with `identity`
</span>  <span class="comment">-- TODO: implement with a parallelizable monoid-parameterized writer
</span>  fold identity (<span class="symbol">\</span>i c<span class="symbol">.</span> binop c xs<span class="symbol">.</span>i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: call this `scan` and call the current `scan` something else
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan&#39; (init<span class="command">:a</span>) (body<span class="command">:n</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> snd <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> dup (body i x)
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: allow tables-via-lambda and get rid of this
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fsum (xs<span class="command">:n</span><span class="symbol">-&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> snd <span class="symbol">$</span> withAccum <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> ref <span class="symbol">+=</span> xs i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sum  (_<span class="symbol">:</span> <span class="type-name">Add</span> v) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> reduce zero (<span class="symbol">+</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> prod (_<span class="symbol">:</span> <span class="type-name">Mul</span> v) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> reduce one  (<span class="symbol">*</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mean (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> sum xs <span class="symbol">/</span> i2r (size n)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> std (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> sqrt <span class="symbol">$</span> mean (map sq xs) <span class="symbol">-</span> sq (mean xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> any (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> reduce <span class="type-name">False</span> (<span class="symbol">||</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> all (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> reduce <span class="type-name">True</span>  (<span class="symbol">&amp;&amp;</span>) xs
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> applyN (n<span class="symbol">:</span><span class="type-name">Int</span>) (x<span class="command">:a</span>) (f<span class="command">:a</span> <span class="symbol">-&gt;</span> a) <span class="symbol">:</span> a <span class="symbol">=</span>
  snd <span class="symbol">$</span> withState x <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> _<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
    ref <span class="symbol">:=</span> f (get ref)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linspace (n<span class="symbol">:</span><span class="type-name">Type</span>) (low<span class="symbol">:</span><span class="type-name">Real</span>) (high<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Real</span> <span class="symbol">=</span>
  dx <span class="symbol">=</span> (high <span class="symbol">-</span> low) <span class="symbol">/</span> i2r (size n)
  <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> low <span class="symbol">+</span> i2r (ordinal i) <span class="symbol">*</span> dx
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transpose (x<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Real</span> <span class="symbol">=</span> <span class="keyword">for</span> i j<span class="symbol">.</span> x<span class="symbol">.</span>j<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vdot (x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Real</span>) (y<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> fsum <span class="symbol">\</span>i<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">*</span> y<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- matmul. Better symbol to use? `@`?
</span></div></div><div class="cell"><div class="code-block">(<span class="symbol">**</span>) <span class="symbol">:</span> (l<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">-&gt;</span> (m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">-&gt;</span> (l<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>
  y&#39; <span class="symbol">=</span> transpose y
  <span class="keyword">for</span> i k<span class="symbol">.</span> fsum <span class="symbol">\</span>j<span class="symbol">.</span> x<span class="symbol">.</span>i<span class="symbol">.</span>j <span class="symbol">*</span> y&#39;<span class="symbol">.</span>k<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">(<span class="symbol">**.</span>) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">-&gt;</span> (m<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">=</span> <span class="symbol">\</span>mat v<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> vdot mat<span class="symbol">.</span>i v
</div></div><div class="cell"><div class="code-block">(<span class="symbol">.**</span>) <span class="symbol">:</span> (m<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">=</span> flip (<span class="symbol">**.</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> inner (x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Real</span>) (mat<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Real</span>) (y<span class="command">:m</span><span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span>
  fsum <span class="symbol">\</span>(i<span class="symbol">,</span>j)<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">*</span> mat<span class="symbol">.</span>i<span class="symbol">.</span>j <span class="symbol">*</span> y<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Functions for working with the pseudorandom number generator</p>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: newtype
</span></div></div><div class="cell"><div class="code-block"><span class="type-name">Key</span> <span class="symbol">=</span> <span class="type-name">Int</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> hash (x<span class="symbol">:</span><span class="type-name">Key</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> %ffi threefry2x32 <span class="type-name">Int</span> x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> newKey (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash 0 x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> splitKey (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> (<span class="type-name">Key</span> <span class="symbol">&amp;</span> <span class="type-name">Key</span>) <span class="symbol">=</span> (hash k 0<span class="symbol">,</span> hash k 1)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> splitKey3 (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> (<span class="type-name">Key</span> <span class="symbol">&amp;</span> <span class="type-name">Key</span> <span class="symbol">&amp;</span> <span class="type-name">Key</span>) <span class="symbol">=</span>
  (k1<span class="symbol">,</span> k&#39;) <span class="symbol">=</span> splitKey k
  (k2<span class="symbol">,</span> k3) <span class="symbol">=</span> splitKey k&#39;
  (k1<span class="symbol">,</span> k2<span class="symbol">,</span> k3)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> many (f<span class="symbol">:</span><span class="type-name">Key</span><span class="symbol">-&gt;</span>a) (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) <span class="symbol">:</span> a <span class="symbol">=</span> f (hash k (ordinal i))
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixkey (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash k (ordinal i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixkey2 (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) (j<span class="command">:m</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash (hash k (ordinal i)) (ordinal j)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %ffi randunif <span class="type-name">Real</span> k
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randn (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span>
  (k1<span class="symbol">,</span> k2) <span class="symbol">=</span> splitKey k
  u1 <span class="symbol">=</span> rand k1
  u2 <span class="symbol">=</span> rand k2
  sqrt ((<span class="symbol">-</span>2<span class="symbol">.</span>0) <span class="symbol">*</span> log u1) <span class="symbol">*</span> cos (2<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">*</span> u2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randIdx (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  unif <span class="symbol">=</span> rand k
  fromOrdinal n <span class="symbol">$</span> floor <span class="symbol">$</span> unif <span class="symbol">*</span> i2r (size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> bern (p<span class="symbol">:</span><span class="type-name">Real</span>) (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rand k <span class="symbol">&lt;</span> p
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randnVec (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Real</span> <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> randn (ixkey k i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>min / max etc</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minBy (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (f x <span class="symbol">&lt;</span> f y) x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maxBy (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (f x <span class="symbol">&gt;</span> f y) x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (x1<span class="symbol">:</span> o) <span class="symbol">-&gt;</span> (x2<span class="symbol">:</span> o) <span class="symbol">:</span> o <span class="symbol">=</span> minBy id x1 x2
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> max (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (x1<span class="symbol">:</span> o) <span class="symbol">-&gt;</span> (x2<span class="symbol">:</span> o) <span class="symbol">:</span> o <span class="symbol">=</span> maxBy id x1 x2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimumBy (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  reduce xs<span class="symbol">.</span>(0<span class="symbol">@</span>_) (minBy f) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximumBy (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  reduce xs<span class="symbol">.</span>(0<span class="symbol">@</span>_) (maxBy f) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimum (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> o <span class="symbol">=</span> minimumBy id xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximum (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> o <span class="symbol">=</span> maximumBy id xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argmin (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> n <span class="symbol">=</span>
  zeroth <span class="symbol">=</span> (0<span class="symbol">@</span>_<span class="symbol">,</span> xs<span class="symbol">.</span>(0<span class="symbol">@</span>_))
  compare <span class="symbol">=</span> <span class="symbol">\</span>(idx1<span class="symbol">,</span> x1) (idx2<span class="symbol">,</span> x2)<span class="symbol">.</span>
    select (x1 <span class="symbol">&lt;</span> x2) (idx1<span class="symbol">,</span> x1) (idx2<span class="symbol">,</span> x2)
  zipped <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> (i<span class="symbol">,</span> xs<span class="symbol">.</span>i)
  fst <span class="symbol">$</span> reduce zeroth compare zipped
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><p>Automatic differentiation</p>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: add vector space constraints
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linearize (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> (b <span class="symbol">&amp;</span> a <span class="symbol">--</span>o b) <span class="symbol">=</span> %linearize f x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> jvp (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">--</span>o b <span class="symbol">=</span> snd (linearize f x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transposeLinear (f<span class="command">:a</span> <span class="symbol">--</span>o b) <span class="symbol">:</span> b <span class="symbol">--</span>o a <span class="symbol">=</span> %linearTranspose f
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vjp (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> (b <span class="symbol">&amp;</span> b <span class="symbol">--</span>o a) <span class="symbol">=</span>
  (y<span class="symbol">,</span> df) <span class="symbol">=</span> linearize f x
  (y<span class="symbol">,</span> transposeLinear df)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> grad (f<span class="command">:a</span><span class="symbol">-&gt;</span><span class="type-name">Real</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> snd (vjp f x) 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> deriv (f<span class="symbol">:</span><span class="type-name">Real</span><span class="symbol">-&gt;</span><span class="type-name">Real</span>) (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> jvp f x 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> derivRev (f<span class="symbol">:</span><span class="type-name">Real</span><span class="symbol">-&gt;</span><span class="type-name">Real</span>) (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> snd (vjp f x) 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> checkDerivBase (f<span class="symbol">:</span><span class="type-name">Real</span><span class="symbol">-&gt;</span><span class="type-name">Real</span>) (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="comment">-- TODO: parse 1e-5
</span>  eps <span class="symbol">=</span> 0<span class="symbol">.</span>00005
  ansFwd  <span class="symbol">=</span> deriv    f x
  ansRev  <span class="symbol">=</span> derivRev f x
  ansNumeric <span class="symbol">=</span> (f (x <span class="symbol">+</span> eps) <span class="symbol">-</span> f (x <span class="symbol">-</span> eps)) <span class="symbol">/</span> (2<span class="symbol">.</span> <span class="symbol">*</span> eps)
  isClose <span class="symbol">=</span> <span class="symbol">\</span>a b<span class="symbol">.</span> abs (a <span class="symbol">-</span> b) <span class="symbol">&lt;</span> 0<span class="symbol">.</span>001
  isClose ansFwd ansNumeric <span class="symbol">&amp;&amp;</span> isClose ansRev ansNumeric
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> checkDeriv (f<span class="symbol">:</span><span class="type-name">Real</span><span class="symbol">-&gt;</span><span class="type-name">Real</span>) (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  checkDerivBase f x <span class="symbol">&amp;&amp;</span> checkDerivBase (deriv f) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> while
    (eff<span class="symbol">:</span><span class="type-name">Effects</span>) <span class="symbol">?-&gt;</span>
    (cond<span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Bool</span>)
    (body<span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Unit</span>)
    <span class="symbol">:</span> {<span class="symbol">|</span>eff} <span class="type-name">Unit</span> <span class="symbol">=</span>
  cond&#39; <span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">InternalBool</span> <span class="symbol">=</span> <span class="symbol">\</span>_<span class="symbol">.</span> unsafeCoerce _ <span class="symbol">$</span> cond ()
  %while cond&#39; body
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Vector support</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">UNSAFEFromOrdinal</span> (n <span class="symbol">:</span> <span class="type-name">Type</span>) (i <span class="symbol">:</span> <span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span> %unsafeAsIndex n i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">VectorWidth</span> <span class="symbol">=</span> 4  <span class="comment">-- XXX: Keep this synced with the constant defined in Array.hs
</span></div></div><div class="cell"><div class="code-block"><span class="type-name">VectorReal</span>  <span class="symbol">=</span> %<span class="type-name">VectorRealType</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> packVector (a <span class="symbol">:</span> <span class="type-name">Real</span>) (b <span class="symbol">:</span> <span class="type-name">Real</span>) (c <span class="symbol">:</span> <span class="type-name">Real</span>) (d <span class="symbol">:</span> <span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">VectorReal</span> <span class="symbol">=</span> %vectorPack a b c d
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> indexVector (v <span class="symbol">:</span> <span class="type-name">VectorReal</span>) (i <span class="symbol">:</span> <span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span> %vectorIndex v i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- NB: Backends should be smart enough to optimize this to a vector load from v
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> loadVector (v <span class="symbol">:</span> (<span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>)<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">VectorReal</span> <span class="symbol">=</span>
  idx <span class="symbol">=</span> <span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>
  (packVector v<span class="symbol">.</span>(<span class="type-name">UNSAFEFromOrdinal</span> idx 0)
              v<span class="symbol">.</span>(<span class="type-name">UNSAFEFromOrdinal</span> idx 1)
              v<span class="symbol">.</span>(<span class="type-name">UNSAFEFromOrdinal</span> idx 2)
              v<span class="symbol">.</span>(<span class="type-name">UNSAFEFromOrdinal</span> idx 3))
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> storeVector (v <span class="symbol">:</span> <span class="type-name">VectorReal</span>) <span class="symbol">:</span> (<span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>)<span class="symbol">=&gt;</span><span class="type-name">Real</span> <span class="symbol">=</span>
  idx <span class="symbol">=</span> <span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>
  [ indexVector v (<span class="type-name">UNSAFEFromOrdinal</span> idx 0)
  <span class="symbol">,</span> indexVector v (<span class="type-name">UNSAFEFromOrdinal</span> idx 1)
  <span class="symbol">,</span> indexVector v (<span class="type-name">UNSAFEFromOrdinal</span> idx 2)
  <span class="symbol">,</span> indexVector v (<span class="type-name">UNSAFEFromOrdinal</span> idx 3) ]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> broadcastVector (v <span class="symbol">:</span> <span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">VectorReal</span> <span class="symbol">=</span> packVector v v v v
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance vectorRealAdd <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">VectorReal</span> <span class="symbol">=</span>
  (<span class="type-name">MkAdd</span> ( <span class="symbol">\</span>x y<span class="symbol">.</span> %vfadd x y )
         ( <span class="symbol">\</span>x y<span class="symbol">.</span> %vfsub x y )
         ( broadcastVector zero ))
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance vectorRealMul <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">VectorReal</span> <span class="symbol">=</span>
  <span class="type-name">MkMul</span> (<span class="symbol">\</span>x y<span class="symbol">.</span> %vfmul x y) <span class="symbol">$</span> packVector 1<span class="symbol">.</span>0 1<span class="symbol">.</span>0 1<span class="symbol">.</span>0 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>instance vectorRealVSpace <span class="symbol">:</span> <span class="type-name">VSpace</span> <span class="type-name">VectorReal</span> <span class="symbol">=</span>
  <span class="type-name">MkVSpace</span> vectorRealAdd <span class="symbol">\</span>x v<span class="symbol">.</span> broadcastVector x <span class="symbol">*</span> v
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Tiling</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Tile</span> (n <span class="symbol">:</span> <span class="type-name">Type</span>) (m <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">IndexSlice</span> n m
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- One can think of instances of `Tile n m` as injective functions `m -&gt; n`,
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- with the special property that consecutive elements of m map to consecutive
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- elements of n. In this view (+&gt;) is just function application, while ++&gt;
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- is currying followed by function application. We cannot represent currying
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- in isolation, because `Tile n (Tile u v)` does not make sense, unlike `Tile n (u &amp; v)`.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+&gt;</span>) (l <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (t<span class="symbol">:</span><span class="type-name">Tile</span> n l) (i <span class="symbol">:</span> l) <span class="symbol">:</span> n <span class="symbol">=</span> %sliceOffset t i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">++&gt;</span>) (t <span class="symbol">:</span> <span class="type-name">Tile</span> n (u <span class="symbol">&amp;</span> v)) (i <span class="symbol">:</span> u) <span class="symbol">:</span> <span class="type-name">Tile</span> n v <span class="symbol">=</span> %sliceCurry t i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tile  (l <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
          (fTile <span class="symbol">:</span> (t<span class="symbol">:</span>(<span class="type-name">Tile</span> n l) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} l<span class="symbol">=&gt;</span>a))
          (fScalar <span class="symbol">:</span> n <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> %tiled fTile fScalar
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tile1 (n <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (l <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (m <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
          (fTile <span class="symbol">:</span> (t<span class="symbol">:</span>(<span class="type-name">Tile</span> n l) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} m<span class="symbol">=&gt;</span>l<span class="symbol">=&gt;</span>a))
          (fScalar <span class="symbol">:</span> n <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} m<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> %tiledd fTile fScalar
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: This should become just `loadVector $ for i. arr.(t +&gt; i)`
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--       once we are able to eliminate temporary arrays. Until then, we inline for performance...
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> loadTile (t <span class="symbol">:</span> <span class="type-name">Tile</span> n (<span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>)) (arr <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">VectorReal</span> <span class="symbol">=</span>
  idx <span class="symbol">=</span> <span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>
  (packVector arr<span class="symbol">.</span>(t <span class="symbol">+&gt;</span> <span class="type-name">UNSAFEFromOrdinal</span> idx 0)
              arr<span class="symbol">.</span>(t <span class="symbol">+&gt;</span> <span class="type-name">UNSAFEFromOrdinal</span> idx 1)
              arr<span class="symbol">.</span>(t <span class="symbol">+&gt;</span> <span class="type-name">UNSAFEFromOrdinal</span> idx 2)
              arr<span class="symbol">.</span>(t <span class="symbol">+&gt;</span> <span class="type-name">UNSAFEFromOrdinal</span> idx 3))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Numerical utilities</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsumexp (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> <span class="type-name">Real</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  m <span class="symbol">+</span> (log <span class="symbol">$</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> exp (x<span class="symbol">.</span>i <span class="symbol">-</span> m))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsoftmax (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Real</span> <span class="symbol">=</span>
  lse <span class="symbol">=</span> logsumexp x
  <span class="keyword">for</span> i<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">-</span> lse
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> softmax (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Real</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  e <span class="symbol">=</span>  <span class="keyword">for</span> i<span class="symbol">.</span> exp (x<span class="symbol">.</span>i <span class="symbol">-</span> m)
  s <span class="symbol">=</span> sum e
  <span class="keyword">for</span> i<span class="symbol">.</span> e<span class="symbol">.</span>i <span class="symbol">/</span> s
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> evalpoly (_<span class="symbol">:</span><span class="type-name">VSpace</span> v) <span class="symbol">?=&gt;</span> (coefficients<span class="command">:n</span><span class="symbol">=&gt;</span>v) (x<span class="symbol">:</span><span class="type-name">Real</span>) <span class="symbol">:</span> v <span class="symbol">=</span>
  <span class="comment">-- Evaluate a polynomial at x.  Same as Numpy&#39;s polyval.
</span>  fold zero <span class="symbol">\</span>i c<span class="symbol">.</span> coefficients<span class="symbol">.</span>i <span class="symbol">+</span> x <span class="symbol">.*</span> c
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">List</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span>
  <span class="type-name">AsList</span> n<span class="symbol">:</span><span class="type-name">Int</span> foo<span class="symbol">:</span>(<span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>) (x<span class="symbol">:</span><span class="type-name">List</span> a) (y<span class="symbol">:</span><span class="type-name">List</span> a) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  (<span class="type-name">AsList</span> nx xs) <span class="symbol">=</span> x
  (<span class="type-name">AsList</span> ny ys) <span class="symbol">=</span> y
  nz <span class="symbol">=</span> nx <span class="symbol">+</span> ny
  <span class="type-name">AsList</span> _ <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> nz)<span class="symbol">.</span>
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">case</span> i&#39; <span class="symbol">&lt;</span> nx <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> xs<span class="symbol">.</span>(fromOrdinal _ i&#39;)
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> ys<span class="symbol">.</span>(fromOrdinal _ (i&#39; <span class="symbol">-</span> nx))
</div></div></div></body></html>