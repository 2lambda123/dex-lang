<!DOCTYPE HTML>
<html><head><link rel="stylesheet" href="style.css" type="text/css"><meta charset="UTF-8"></head><body><div id="main-output"><div class="cell"><div class="code-block"><span class="comment">-- We definitely want to improve this in the future, but it&#39;s fine if we only care
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- about matrices that tile perfectly.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tile2d (n <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (m <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (b <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (nl <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (ml <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
           (fTile <span class="symbol">:</span> <span class="type-name">Tile</span> n nl <span class="symbol">-&gt;</span> <span class="type-name">Tile</span> m ml <span class="symbol">-&gt;</span> nl<span class="symbol">=&gt;</span>ml<span class="symbol">=&gt;</span>b)
           (fScalar <span class="symbol">:</span> n <span class="symbol">-&gt;</span> m <span class="symbol">-&gt;</span> b) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span>b <span class="symbol">=</span>
  (tile
    (<span class="symbol">\</span>nt<span class="symbol">:</span>(<span class="type-name">Tile</span> n nl)<span class="symbol">.</span>
      (tile1 (<span class="symbol">\</span>mt<span class="symbol">:</span>(<span class="type-name">Tile</span> m ml)<span class="symbol">.</span> fTile nt mt)
             (<span class="symbol">\</span>mi<span class="command">:m</span><span class="symbol">.</span> <span class="keyword">for</span> ni<span class="command">:nl</span><span class="symbol">.</span> fScalar (nt <span class="symbol">+&gt;</span> ni) mi)))
    (<span class="symbol">\</span>ni<span class="command">:n</span><span class="symbol">.</span> <span class="keyword">for</span> mi<span class="command">:m</span><span class="symbol">.</span> fScalar ni mi))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> matmul (k <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (n <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (m <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
           (a <span class="symbol">:</span> n<span class="symbol">=&gt;</span>k<span class="symbol">=&gt;</span><span class="type-name">Real</span>) (b <span class="symbol">:</span> k<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Real</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Real</span> <span class="symbol">=</span>
  rowTile <span class="symbol">=</span> <span class="type-name">Fin</span> 3
  colVectors <span class="symbol">=</span> <span class="type-name">Fin</span> 3
  vectorTile <span class="symbol">=</span> <span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>
  colTile <span class="symbol">=</span> (colVectors <span class="symbol">&amp;</span> vectorTile)
  (tile2d (<span class="symbol">\</span>nt<span class="symbol">:</span>(<span class="type-name">Tile</span> n rowTile)<span class="symbol">.</span> <span class="symbol">\</span>mt<span class="symbol">:</span>(<span class="type-name">Tile</span> m colTile)<span class="symbol">.</span>
             ct <span class="symbol">=</span> snd <span class="symbol">$</span> withAccum <span class="symbol">\</span>acc<span class="symbol">.</span>
               <span class="keyword">for</span> l<span class="command">:k</span><span class="symbol">.</span>
                 <span class="keyword">for</span> i<span class="command">:rowTile</span><span class="symbol">.</span>
                   ail <span class="symbol">=</span> broadcastVector a<span class="symbol">.</span>(nt <span class="symbol">+&gt;</span> i)<span class="symbol">.</span>l
                   <span class="keyword">for</span> j<span class="command">:colVectors</span><span class="symbol">.</span>
                     acc<span class="symbol">!</span>i<span class="symbol">!</span>j <span class="symbol">+=</span> ail <span class="symbol">*</span> loadTile (mt <span class="symbol">++&gt;</span> j) b<span class="symbol">.</span>l
             <span class="keyword">for</span> i<span class="command">:rowTile</span><span class="symbol">.</span> <span class="keyword">for</span> (j<span class="symbol">,</span> j&#39;)<span class="command">:colTile</span><span class="symbol">.</span>
               indexVector ct<span class="symbol">.</span>i<span class="symbol">.</span>j j&#39;)
          (<span class="symbol">\</span>i<span class="command">:n</span><span class="symbol">.</span> <span class="symbol">\</span>j<span class="command">:m</span><span class="symbol">.</span> fsum <span class="symbol">\</span>l<span class="symbol">.</span> a<span class="symbol">.</span>i<span class="symbol">.</span>l <span class="symbol">*</span> b<span class="symbol">.</span>l<span class="symbol">.</span>j))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">a <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> 5)<span class="symbol">.</span> <span class="keyword">for</span> j<span class="symbol">:</span>(<span class="type-name">Fin</span> 8)<span class="symbol">.</span> i2r <span class="symbol">$</span> (iota _)<span class="symbol">.</span>(i<span class="symbol">,</span>j)
</div></div><div class="cell"><div class="code-block">b <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> 8)<span class="symbol">.</span> <span class="keyword">for</span> j<span class="symbol">:</span>(<span class="type-name">Fin</span> 15)<span class="symbol">.</span> i2r <span class="symbol">$</span> (iota _)<span class="symbol">.</span>(i<span class="symbol">,</span>j)
</div></div><div class="cell"><div class="code-block">c <span class="symbol">=</span> matmul a b
</div></div><div class="cell"><div class="code-block">c<span class="symbol">.</span>(0<span class="symbol">@</span>_)
</div><div class="result-block">[ 2100.0
, 2128.0
, 2156.0
, 2184.0
, 2212.0
, 2240.0
, 2268.0
, 2296.0
, 2324.0
, 2352.0
, 2380.0
, 2408.0
, 2436.0
, 2464.0
, 2492.0 ]</div></div><div class="cell"><div class="code-block">c<span class="symbol">.</span>(4<span class="symbol">@</span>_)
</div><div class="result-block">[ 15540.0
, 15824.0
, 16108.0
, 16392.0
, 16676.0
, 16960.0
, 17244.0
, 17528.0
, 17812.0
, 18096.0
, 18380.0
, 18664.0
, 18948.0
, 19232.0
, 19516.0 ]</div></div></div></body></html>